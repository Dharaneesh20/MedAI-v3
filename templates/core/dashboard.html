{% extends 'base.html' %}

{% block title %}Dashboard - MedAi{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h1 class="display-6 fw-bold mb-4">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </h1>
            <p class="lead">Welcome back, {{ user.first_name }}! Choose how you'd like to analyze your medications today.</p>
        </div>
    </div>

    <!-- Analysis Methods -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card input-method text-method text-white h-100" onclick="showTextAnalysis()">
                <div class="card-body text-center">
                    <i class="fas fa-keyboard fa-4x mb-3"></i>
                    <h4>Text Analysis</h4>
                    <p>Type medication names for quick analysis</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card input-method image-method text-white h-100" onclick="showImageAnalysis()">
                <div class="card-body text-center">
                    <i class="fas fa-camera fa-4x mb-3"></i>
                    <h4>Image OCR</h4>
                    <p>Upload prescription or medication photos</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card input-method voice-method text-dark h-100" onclick="showVoiceAnalysis()">
                <div class="card-body text-center">
                    <i class="fas fa-microphone fa-4x mb-3"></i>
                    <h4>Voice Input</h4>
                    <p>Speak your medication names</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Forms -->
    <div id="analysisSection" class="row" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0" id="analysisTitle">Analysis</h5>
                    <button type="button" class="btn-close" onclick="hideAnalysis()"></button>
                </div>
                <div class="card-body">
                    <!-- Text Analysis Form -->
                    <div id="textForm" style="display: none;">
                        <form id="textAnalysisForm">
                            <div class="mb-3">
                                <label for="medications" class="form-label">Enter Medications</label>
                                <textarea class="form-control" id="medications" rows="3" 
                                         placeholder="Enter medication names separated by commas (e.g., Aspirin, Metformin, Lisinopril)"></textarea>
                                <div class="form-text">Enter each medication on a new line or separated by commas.</div>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="includePatientInfo" checked>
                                <label class="form-check-label" for="includePatientInfo">
                                    Include my medical information for personalized analysis
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Analyze Medications
                            </button>
                        </form>
                    </div>

                    <!-- Image Analysis Form -->
                    <div id="imageForm" style="display: none;">
                        <form id="imageAnalysisForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="imageFile" class="form-label">Upload Medication Image</label>
                                <input class="form-control" type="file" id="imageFile" accept="image/*">
                                <div class="form-text">Upload a clear photo of your prescription or medication labels.</div>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="includePatientInfoImg" checked>
                                <label class="form-check-label" for="includePatientInfoImg">
                                    Include my medical information for personalized analysis
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-upload"></i> Upload and Analyze
                            </button>
                        </form>
                    </div>

                    <!-- Voice Analysis Form -->
                    <div id="voiceForm" style="display: none;">
                        <form id="voiceAnalysisForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="audioFile" class="form-label">Upload Audio Recording</label>
                                <input class="form-control" type="file" id="audioFile" accept="audio/*">
                                <div class="form-text">Upload an audio file where you mention your medication names.</div>
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-secondary" id="recordButton">
                                    <i class="fas fa-microphone"></i> Record Audio
                                </button>
                                <div class="form-text">Or record audio directly in your browser (requires microphone permission).</div>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="includePatientInfoVoice" checked>
                                <label class="form-check-label" for="includePatientInfoVoice">
                                    Include my medical information for personalized analysis
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-microphone"></i> Analyze Audio
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="row mt-4" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Analysis Results</h5>
                </div>
                <div class="card-body" id="resultsContent">
                    <!-- Results will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Conversations -->
    <div class="row mt-5">
        <div class="col-12">
            <h3>Recent Conversations</h3>
            {% if recent_conversations %}
            <div class="row g-3">
                {% for conversation in recent_conversations %}
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="card-title">
                                        {% if conversation.analysis_type == 'text' %}
                                            <i class="fas fa-keyboard text-danger"></i>
                                        {% elif conversation.analysis_type == 'image' %}
                                            <i class="fas fa-camera text-info"></i>
                                        {% else %}
                                            <i class="fas fa-microphone text-success"></i>
                                        {% endif %}
                                        {{ conversation.analysis_type|title }} Analysis
                                    </h6>
                                    <p class="card-text small text-muted">{{ conversation.input_text|truncatechars:100 }}</p>
                                    <small class="text-muted">{{ conversation.created_at }}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-{% if conversation.safety_score >= 80 %}success{% elif conversation.safety_score >= 60 %}warning{% else %}danger{% endif %}">
                                        {{ conversation.safety_score }}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="mt-3">
                <a href="/api/history/" class="btn btn-outline-primary">View All Conversations</a>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-history fa-3x text-muted mb-3"></i>
                <p class="text-muted">No previous conversations yet. Start your first analysis above!</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showTextAnalysis() {
    document.getElementById('analysisSection').style.display = 'block';
    document.getElementById('analysisTitle').textContent = 'Text Analysis';
    
    // Hide all forms
    document.getElementById('textForm').style.display = 'none';
    document.getElementById('imageForm').style.display = 'none';
    document.getElementById('voiceForm').style.display = 'none';
    
    // Show text form
    document.getElementById('textForm').style.display = 'block';
    document.getElementById('analysisSection').scrollIntoView({ behavior: 'smooth' });
}

function showImageAnalysis() {
    document.getElementById('analysisSection').style.display = 'block';
    document.getElementById('analysisTitle').textContent = 'Image OCR Analysis';
    
    // Hide all forms
    document.getElementById('textForm').style.display = 'none';
    document.getElementById('imageForm').style.display = 'none';
    document.getElementById('voiceForm').style.display = 'none';
    
    // Show image form
    document.getElementById('imageForm').style.display = 'block';
    document.getElementById('analysisSection').scrollIntoView({ behavior: 'smooth' });
}

function showVoiceAnalysis() {
    document.getElementById('analysisSection').style.display = 'block';
    document.getElementById('analysisTitle').textContent = 'Voice Analysis';
    
    // Hide all forms
    document.getElementById('textForm').style.display = 'none';
    document.getElementById('imageForm').style.display = 'none';
    document.getElementById('voiceForm').style.display = 'none';
    
    // Show voice form
    document.getElementById('voiceForm').style.display = 'block';
    document.getElementById('analysisSection').scrollIntoView({ behavior: 'smooth' });
}

function hideAnalysis() {
    document.getElementById('analysisSection').style.display = 'none';
    document.getElementById('resultsSection').style.display = 'none';
}

// Form submission handlers
document.getElementById('textAnalysisForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const medications = document.getElementById('medications').value;
    const includePatientInfo = document.getElementById('includePatientInfo').checked;
    
    if (!medications.trim()) {
        alert('Please enter at least one medication.');
        return;
    }
    
    // Parse medications
    const medicationList = medications.split(/[,\n]/).map(m => m.trim()).filter(m => m);
    
    try {
        const response = await fetch('/api/analysis/text/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}` // You'll need to implement token storage
            },
            body: JSON.stringify({
                medications: medicationList,
                include_patient_info: includePatientInfo
            })
        });
        
        const result = await response.json();
        displayResults(result);
    } catch (error) {
        console.error('Error:', error);
        alert('Analysis failed. Please try again.');
    }
});

// Image form submission handler
document.getElementById('imageAnalysisForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const imageFile = document.getElementById('imageFile').files[0];
    const includePatientInfo = document.getElementById('includePatientInfoImg').checked;
    
    if (!imageFile) {
        alert('Please select an image file.');
        return;
    }
    
    // Show loading state
    const submitButton = this.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    submitButton.disabled = true;
    
    try {
        const formData = new FormData();
        formData.append('image', imageFile);
        formData.append('include_patient_info', includePatientInfo);
        
        const response = await fetch('/api/analysis/image/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            displayImageResults(result);
        } else {
            alert(result.error || 'Image analysis failed. Please try again.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Image analysis failed. Please try again.');
    } finally {
        // Restore button state
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    }
});

// Voice form submission handler
document.getElementById('voiceAnalysisForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const audioFile = document.getElementById('audioFile').files[0];
    const includePatientInfo = document.getElementById('includePatientInfoVoice').checked;
    
    if (!audioFile) {
        alert('Please select an audio file.');
        return;
    }
    
    // Show loading state
    const submitButton = this.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    submitButton.disabled = true;
    
    try {
        const formData = new FormData();
        formData.append('audio', audioFile);
        formData.append('include_patient_info', includePatientInfo);
        
        const response = await fetch('/api/analysis/voice/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            displayVoiceResults(result);
        } else {
            alert(result.error || 'Voice analysis failed. Please try again.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Voice analysis failed. Please try again.');
    } finally {
        // Restore button state
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    }
});

function displayImageResults(results) {
    const resultsContent = document.getElementById('resultsContent');
    
    resultsContent.innerHTML = `
        <div class="row">
            <div class="col-md-8">
                <h6>OCR Extracted Text:</h6>
                <div class="alert alert-info">
                    <pre>${results.ocr_text || 'No text extracted'}</pre>
                </div>
                
                <h6>Medications Found:</h6>
                <p>${results.medications_found?.join(', ') || 'None detected'}</p>
                
                <h6>Drug Interaction Analysis:</h6>
                <div class="mb-3">
                    <pre style="white-space: pre-wrap;">${results.analysis_result || 'No analysis available'}</pre>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <h6>Analysis Type</h6>
                    <span class="badge bg-primary fs-5">Image OCR</span>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('resultsSection').style.display = 'block';
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

function displayVoiceResults(results) {
    const resultsContent = document.getElementById('resultsContent');
    
    resultsContent.innerHTML = `
        <div class="row">
            <div class="col-md-8">
                <h6>Transcribed Text:</h6>
                <div class="alert alert-info">
                    <p>${results.transcribed_text || 'No speech recognized'}</p>
                </div>
                
                <h6>Medications Found:</h6>
                <p>${results.medications_found?.join(', ') || 'None detected'}</p>
                
                <h6>Drug Interaction Analysis:</h6>
                <div class="mb-3">
                    <pre style="white-space: pre-wrap;">${results.analysis_result || 'No analysis available'}</pre>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <h6>Analysis Type</h6>
                    <span class="badge bg-success fs-5">Voice Input</span>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('resultsSection').style.display = 'block';
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

function displayResults(results) {
    const resultsContent = document.getElementById('resultsContent');
    
    let safetyBadgeClass = 'success';
    if (results.safety_score < 60) safetyBadgeClass = 'danger';
    else if (results.safety_score < 80) safetyBadgeClass = 'warning';
    
    resultsContent.innerHTML = `
        <div class="row">
            <div class="col-md-8">
                <h6>Medications Analyzed:</h6>
                <p>${results.medications_analyzed.join(', ')}</p>
                
                <h6>Drug Interactions:</h6>
                <div class="mb-3">
                    <strong>Major:</strong> ${results.drug_interactions.major}<br>
                    <strong>Moderate:</strong> ${results.drug_interactions.moderate}<br>
                    <strong>Minor:</strong> ${results.drug_interactions.minor}
                </div>
                
                <h6>Recommendations:</h6>
                <p>${results.recommendations}</p>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <h6>Safety Score</h6>
                    <span class="badge bg-${safetyBadgeClass} fs-4">${results.safety_score}%</span>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('resultsSection').style.display = 'block';
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}
